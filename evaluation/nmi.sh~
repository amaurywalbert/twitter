#!/bin/bash
######################################################################################################################################################################
##		Status - Versão 1 - Rodar o algoritmo de validação dos resultados - Nomalized Mutual Information
##					- NMI - Andrea Lancichinetti et al 2009 New J. Phys. 11 033015
##			 					
## # INPUT:
##		- Comunidades detectadas - Arquivos texto para cada ego em que cada linha contendo os ids do usuários representam uma comunidade do ego.
##		- Comunidades Ground-Truth - Arquivo texto para cada ego em que cada linha contendo os ids do usuários representam uma Lista do ego.
## # OUTPUT:
##		- Comunidades
######################################################################################################################################################################

op=0
clear
METRIC="nmi"


copra()
{
	clear
	#PARÂMETROS $DESCRIPTION $TYPE_GRAPH $NET $METRIC $ALG
	DESCRIPTION=$1
	TYPE_GRAPH=$2
	NET=$3
	METRIC=$4
	SINGLETONS=$5
	ALG=$6
	GROUND_TRUTH=/home/amaury/dataset/ground_truth/lists_users_TXT/$SINGLETONS/
	COMMUNITIES=/home/amaury/communities/$TYPE_GRAPH/$ALG/$SINGLETONS/$NET/
	OUTPUT_DIR=/home/amaury/Dropbox/evaluation/$TYPE_GRAPH/$ALG/$METRIC/$SINGLETONS/$NET/
	############################################################################################################
	mkdir -p $OUTPUT_DIR
	V=20	#Parâmetro do COPRA
	echo
	echo "Calculando $METRIC para a rede $NET"
	echo
	echo "Os arquivos serão armazenados em: $OUTPUT_DIR"
	for ((THRESHOLD=1; THRESHOLD<=$V; THRESHOLD++)); do
		i=0 		#Ponteiro para o ego
		e=0		#Quantidade de arquivos compativeis... Alguns arquivos para algumas variações do parâmetro V não foram obtidos.
		if [ -e $OUTPUT_DIR$THRESHOLD".txt" ] ; then
			rm $OUTPUT_DIR$THRESHOLD".txt"				# Remover arquivos existentes na pasta de saída.
		fi	
		for file in `ls $COMMUNITIES$THRESHOLD`; do
			let i=$i+1;
			IFS="." read -a fields <<<"$file"					# Renomear (temp) o arquivo "clusters-97197087.edge_list" para clusters-97197087
			IFS="-" read -a file_temp <<<"${fields[0]}"		# Renomear (temp) o arquivo "97197087.edge_list" para 97197087
			
			if [ -e $GROUND_TRUTH${file_temp[1]}".txt" ] ; then
				echo "Calculando $METRIC para o ego: $i - THRESHOLD $THRESHOLD"
#				echo "Ground-Truth File: ${file_temp[1]}".txt" ----- Communitites Detected File: $file"
				/home/amaury/algoritmos/Metricas/mutual3/mutual $COMMUNITIES$THRESHOLD/$file $GROUND_TRUTH${file_temp[1]}".txt" >> $OUTPUT_DIR$THRESHOLD".txt"
				let e=$e+1;
			else
				echo "ERROR - EGO: $i - Arquivo não encontrado!"
			fi
		done
		echo "COPRA - Total de arquivos verificados para o THRESHOLD $THRESHOLD: $e"
	echo "###############################################################"
	echo "###############################################################"
	echo
	done
}

instructions()
{
	#PARÂMETROS $DESCRIPTION $TYPE_GRAPH $NET $METRIC
	clear
	echo "###############################################################"
	echo "																					"
	echo " Algoritmo para cálculo da métrica $METRIC - versão BATCH"
	echo "																					"
	echo "###############################################################"
	echo
	echo " 01 - COPRA"
	echo	
	echo -n "Informe o algoritmo que gerou as comunidades para que seja calculada a métrica: "
	read op2
	case $op2 in
	01)ALG=copra
		copra $1 $2 $3 $4 $5 $ALG
		;;

	*) echo
		echo "Opção Inválida! Saindo do script..."
		echo
		exit
		;;
	esac
}
############################################################################################################
echo "###############################################################"
echo "																					"
echo " Algoritmo para cálculo da métrica $METRIC - versão BATCH"
echo "																					"
echo "###############################################################"
echo
echo " 01) Rede N1 - Follow"
echo " 02) Rede N2 - Retweets"
echo " 03) Rede N3 - Likes"
echo " 04) Rede N4 - Mentions"
echo " 09) Rede N9 - Followers"
echo
echo " 05) Rede N5 - Co-Follow"
echo " 06) Rede N6 - Co-Retweets"
echo " 07) Rede N7 - Co-Likes"
echo " 08) Rede N8 - Co-Mentions"
echo " 10) Rede N10 - Co-Followers"
echo
echo -n "Escolha uma opção: "
read op
echo
###############################################################  LINHAS A SEREM MODIFICADAS DE ACORDO COM A REDE-EGO
case $op in

01)DESCRIPTION="Follow"	
	NET="n1"
	;;

02)DESCRIPTION="Retweets"
	NET="n2"
	;;

03)DESCRIPTION="Likes"
	NET="n3"
	;;

04)DESCRIPTION="Mentions"
	NET="n4"
	;;

05)DESCRIPTION="Co-Follow"
	NET="n5"
	;;

06)DESCRIPTION="Co-Retweets"
	NET="n6"
	;;

07)DESCRIPTION="Co-Likes"
	NET="n7"
	;;

08)DESCRIPTION="Co-Mentions"
	NET="n8"
	;;

09)DESCRIPTION="Followers"
	NET="n9"
	;;

10)DESCRIPTION="Co-Followers"
	NET="n10"
	;;

*) echo
	echo "Opção Inválida! Saindo do script..."
	echo
	exit
	;;
esac

echo "###############################################################"
echo "Realizar o cálculo usando Singletons?" 
echo " 01 - SIM (Padrão)"
echo " 02 - NÃO"
echo
echo -n "Escolha uma opção: "
read op2

if [ -z $op2 ]; then
	SINGLETONS="singletons"
elif [ $op2 == 02 ]; then
	SINGLETONS="full"
else
	SINGLETONS="with_singletons"
fi

#Execução do algoritmo...
###############################################################
instructions $DESCRIPTION "graphs_without_ego" $NET $METRIC	$SINGLETONS		# Roda o script para a rede criada SEM o ego
instructions $DESCRIPTION "graphs_with_ego" $NET $METRIC	$SINGLETONS		# Roda o script para a rede criada COM o ego
